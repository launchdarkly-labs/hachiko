name: Migration Dashboard Manager

# Trigger on migration-dashboard issue edits and PR events
on:
  issues:
    types: [edited]
  pull_request:
    types: [opened, synchronize, closed]

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - "update_issue"
          - "start_migration"
          - "pause_migration"

permissions:
  contents: write # To create PRs and update files
  issues: write # To update migration-dashboard issue
  pull-requests: write # To create and manage PRs
  actions: write # To trigger workflow dispatches

# Prevent concurrent executions to avoid double-triggering migrations
concurrency:
  group: migration-dashboard-${{ github.repository }}
  cancel-in-progress: false # Queue instead of cancelling to avoid losing checkbox changes

jobs:
  handle-migration-dashboard:
    name: Handle Migration Dashboard Event
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.3
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: |
          pnpm install
          pnpm build

      - name: Identify migration-dashboard issue
        id: find-issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find or create the migration-dashboard issue
          ISSUE_NUMBER=$(gh issue list --label "hachiko:migration-dashboard" --json number --jq '.[0].number // empty')

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "Creating migration-dashboard issue..."
            ISSUE_URL=$(gh issue create \
              --title "üìä Hachiko Migration Dashboard" \
              --label "hachiko:migration-dashboard" \
              --body "$(cat <<'EOF'
          # üìä Hachiko Migration Dashboard

          This issue tracks all active migrations in the repository. Use the checkboxes below to control migration execution.

          ## üü° Pending Migrations

          ‚ú® *No pending migrations*

          ## üîÑ In-Progress Migrations

          ‚ú® *No active migrations*

          ## ‚è∏Ô∏è Paused Migrations

          ‚ú® *No paused migrations*

          ---

          **How to use:**
          - ‚úÖ Check a box next to a pending migration to start it
          - ‚úÖ Check a box next to a paused migration to resume it
          - ‚ùå Closing a Hachiko PR will pause the migration
          - üîÑ This dashboard updates automatically as migrations progress

          ü§ñ *Managed by Hachiko - Do not edit the sections above manually*
          EOF
          )")
            ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -o '[0-9]*$')
          fi

          echo "migration_dashboard_issue=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "Found/created migration-dashboard issue #$ISSUE_NUMBER"

      - name: Handle issue edit
        if: github.event_name == 'issues' && github.event.issue.number == fromJson(steps.find-issue.outputs.migration_dashboard_issue)
        id: handle-edit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "Migration-dashboard issue edited"

          # Parse the issue body to detect checkbox changes
          ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body')

          # Extract checked migrations from Pending section
          CHECKED_PENDING=$(echo "$ISSUE_BODY" | awk '/## üü° Pending Migrations/,/## üîÑ In-Progress Migrations/ { if (/^- \[x\]/) print }' | sed 's/^- \[x\] `//' | sed 's/`.*$//')

          # Extract checked migrations from In-Progress section (for triggering next step)
          CHECKED_IN_PROGRESS=$(echo "$ISSUE_BODY" | awk '/## üîÑ In-Progress Migrations/,/## ‚è∏Ô∏è Paused Migrations/ { if (/^- \[x\]/) print }' | sed 's/^- \[x\] `//' | sed 's/`.*$//')

          # Extract checked migrations from Paused section  
          CHECKED_PAUSED=$(echo "$ISSUE_BODY" | awk '/## ‚è∏Ô∏è Paused Migrations/,/---/ { if (/^- \[x\]/) print }' | sed 's/^- \[x\] `//' | sed 's/`.*$//')

          # Extract restart requests from In-Progress section (nested checkboxes like "- [ ] Start step X")
          RESTART_REQUESTS=$(echo "$ISSUE_BODY" | awk '
            /## üîÑ In-Progress Migrations/,/## ‚è∏Ô∏è Paused Migrations/ {
              if (/^    - \[x\] Start step/) {
                # Extract step number
                gsub(/.*Start step /, "")
                gsub(/[^0-9].*/, "")
                step = $0
                
                # Find the migration ID from the previous lines
                for (i = NR-10; i < NR; i++) {
                  if (lines[i] ~ /^- `[^`]+` - /) {
                    gsub(/^- `/, "", lines[i])
                    gsub(/` - .*/, "", lines[i])
                    print lines[i] ":" step
                    break
                  }
                }
              }
              lines[NR] = $0
            }
          ')

          # Helper function to check if migration is already running
          check_migration_running() {
            local migration_id="$1"
            # Check for running execute-migration workflows for this migration
            RUNNING_COUNT=$(gh run list --workflow=execute-migration.yml --status=in_progress --json conclusion | jq 'length')
            if [ "$RUNNING_COUNT" -gt 0 ]; then
              echo "‚ö†Ô∏è Execution workflow already running - skipping trigger for $migration_id"
              return 0
            fi
            return 1
          }

          # Process checked migrations from Pending section (restart from current step)
          MIGRATIONS_TRIGGERED=false
          for MIGRATION_ID in $CHECKED_PENDING; do
            if [ -n "$MIGRATION_ID" ] && [ "$MIGRATION_ID" != "‚ú®" ]; then
              echo "Starting pending migration: $MIGRATION_ID"
              
              # Check if migration is already running
              if check_migration_running "$MIGRATION_ID"; then
                continue
              fi
              
              # For pending migrations, start from step 1
              CURRENT_STEP=1
              echo "Migration $MIGRATION_ID starting at step: $CURRENT_STEP"
              
              # Trigger migration execution
              gh workflow run execute-migration.yml \
                -f migration_id="$MIGRATION_ID" \
                -f step_id="$CURRENT_STEP"
              
              MIGRATIONS_TRIGGERED=true
            fi
          done

          # Process checked migrations from Paused section (resume from current step)
          for MIGRATION_ID in $CHECKED_PAUSED; do
            if [ -n "$MIGRATION_ID" ] && [ "$MIGRATION_ID" != "‚ú®" ]; then
              echo "Resuming paused migration: $MIGRATION_ID"
              
              # Check if migration is already running
              if check_migration_running "$MIGRATION_ID"; then
                continue
              fi
              
              # Get current step from calculated state (preferred) or fallback to migration file
              echo "üîç Calculating current step for $MIGRATION_ID from PR activity..."
              STATE_OUTPUT=$(GITHUB_TOKEN="${GITHUB_TOKEN}" GITHUB_REPOSITORY="${GITHUB_REPOSITORY}" node dist/scripts/get-migration-state.js "$MIGRATION_ID" 2>/dev/null || echo "")
              
              if [ -n "$STATE_OUTPUT" ]; then
                CURRENT_STEP=$(echo "$STATE_OUTPUT" | grep "^current_step=" | cut -d'=' -f2)
                echo "Migration $MIGRATION_ID resuming at step: $CURRENT_STEP (calculated from PR activity)"
              else
                echo "‚ö†Ô∏è Could not calculate step from PR activity, falling back to migration file"
                MIGRATION_FILE="migrations/${MIGRATION_ID}.md"
                if [ -f "$MIGRATION_FILE" ]; then
                  CURRENT_STEP=$(awk '/^---$/{if(f==1) exit; f=1; next} f' "$MIGRATION_FILE" | grep "^current_step:" | sed 's/current_step: *//')
                  # Default to step 1 if not found or invalid
                  if ! [[ "$CURRENT_STEP" =~ ^[0-9]+$ ]] || [ "$CURRENT_STEP" -lt 1 ]; then
                    CURRENT_STEP=1
                  fi
                  echo "Migration $MIGRATION_ID resuming at step: $CURRENT_STEP (from frontmatter)"
                else
                  echo "Warning: Migration file not found, defaulting to step 1"
                  CURRENT_STEP=1
                fi
              fi
              
              # Trigger migration execution
              gh workflow run execute-migration.yml \
                -f migration_id="$MIGRATION_ID" \
                -f step_id="$CURRENT_STEP"
              
              MIGRATIONS_TRIGGERED=true
            fi
          done

          # Process checked migrations from In-Progress section (advance to next step)
          for MIGRATION_ID in $CHECKED_IN_PROGRESS; do
            if [ -n "$MIGRATION_ID" ] && [ "$MIGRATION_ID" != "‚ú®" ]; then
              echo "Advancing in-progress migration: $MIGRATION_ID"
              
              # Check if migration is already running
              if check_migration_running "$MIGRATION_ID"; then
                continue
              fi
              
              # Get current step from calculated state (preferred) or fallback to migration file
              echo "üîç Calculating current step for $MIGRATION_ID from PR activity..."
              STATE_OUTPUT=$(GITHUB_TOKEN="${GITHUB_TOKEN}" GITHUB_REPOSITORY="${GITHUB_REPOSITORY}" node dist/scripts/get-migration-state.js "$MIGRATION_ID" 2>/dev/null || echo "")
              
              if [ -n "$STATE_OUTPUT" ]; then
                CURRENT_STEP=$(echo "$STATE_OUTPUT" | grep "^current_step=" | cut -d'=' -f2)
                NEXT_STEP=$((CURRENT_STEP + 1))
                echo "Migration $MIGRATION_ID advancing from step $CURRENT_STEP to step $NEXT_STEP (calculated from PR activity)"
              else
                echo "‚ö†Ô∏è Could not calculate step from PR activity, falling back to migration file"
                MIGRATION_FILE="migrations/${MIGRATION_ID}.md"
                if [ -f "$MIGRATION_FILE" ]; then
                  CURRENT_STEP=$(awk '/^---$/{if(f==1) exit; f=1; next} f' "$MIGRATION_FILE" | grep "^current_step:" | sed 's/current_step: *//')
                  # Default to step 1 if not found or invalid
                  if ! [[ "$CURRENT_STEP" =~ ^[0-9]+$ ]] || [ "$CURRENT_STEP" -lt 1 ]; then
                    CURRENT_STEP=1
                  fi
                  NEXT_STEP=$((CURRENT_STEP + 1))
                  echo "Migration $MIGRATION_ID advancing from step $CURRENT_STEP to step $NEXT_STEP (from frontmatter)"
                else
                  echo "Warning: Migration file not found, defaulting to next step as step 2"
                  NEXT_STEP=2
                fi
              fi
              
              # Trigger migration execution with next step
              gh workflow run execute-migration.yml \
                -f migration_id="$MIGRATION_ID" \
                -f step_id="$NEXT_STEP"
              
              MIGRATIONS_TRIGGERED=true
            fi
          done

          # Process restart requests from In-Progress section
          if [ -n "$RESTART_REQUESTS" ]; then
            echo "$RESTART_REQUESTS" | while IFS=':' read -r MIGRATION_ID STEP_ID; do
              if [ -n "$MIGRATION_ID" ] && [ -n "$STEP_ID" ]; then
                echo "Manually restarting migration: $MIGRATION_ID at step $STEP_ID"
                
                # Check if migration is already running
                if check_migration_running "$MIGRATION_ID"; then
                  continue
                fi
                
                # Trigger migration execution with specified step
                gh workflow run execute-migration.yml \
                  -f migration_id="$MIGRATION_ID" \
                  -f step_id="$STEP_ID"
                
                MIGRATIONS_TRIGGERED=true
              fi
            done
          fi

          # Set output for conditional issue update
          echo "migrations_triggered=$MIGRATIONS_TRIGGERED" >> $GITHUB_OUTPUT

      - name: Handle PR opened/updated
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize')
        id: handle-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "PR ${{ github.event.action }}: $PR_TITLE"
          echo "Branch: $PR_BRANCH"

          # Check if this is a Hachiko migration PR (by branch or label)
          IS_HACHIKO_PR=false
          if [[ "$PR_BRANCH" == hachiko/* ]]; then
            IS_HACHIKO_PR=true
            echo "‚úÖ Hachiko migration PR detected by branch name: $PR_BRANCH"
          elif gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' | grep -q "hachiko:migration"; then
            IS_HACHIKO_PR=true
            echo "‚úÖ Hachiko migration PR detected by label"
          else
            echo "‚ÑπÔ∏è Not a Hachiko migration PR - no dashboard update needed"
          fi

          echo "is_hachiko_pr=$IS_HACHIKO_PR" >> $GITHUB_OUTPUT

          # If this is a Hachiko migration PR being opened, it means a migration just started
          if [ "$IS_HACHIKO_PR" = "true" ] && [ "${{ github.event.action }}" = "opened" ]; then
            echo "üöÄ Migration PR opened - this indicates migration execution started"
            echo "üìä Dashboard will be updated to reflect the new in-progress migration"
          fi

      - name: Handle PR closure
        if: github.event_name == 'pull_request' && github.event.pull_request.state == 'closed'
        id: handle-pr-closure
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_MERGED: ${{ github.event.pull_request.merged }}
        run: |
          echo "PR closed: $PR_TITLE"
          echo "Branch: $PR_BRANCH"

          IS_HACHIKO_PR=false
          
          # Check if this is a Hachiko migration branch
          if [[ "$PR_BRANCH" == hachiko/* ]]; then
            IS_HACHIKO_PR=true
            # Extract migration ID from branch name
            MIGRATION_ID=$(echo "$PR_BRANCH" | sed 's/hachiko\///' | sed 's/-step-[0-9]*//')
            
            if [ -n "$MIGRATION_ID" ]; then
              echo "Hachiko migration branch detected: $MIGRATION_ID"
              
              if [ "$PR_MERGED" = "true" ]; then
                echo "PR was merged - advancing migration"
                # This would trigger the next step or completion
                ./scripts/advance-migration.sh "$MIGRATION_ID"
              else
                echo "PR was closed without merging - pausing migration"
                # Update migration status to paused
                ./scripts/pause-migration.sh "$MIGRATION_ID"
              fi
            fi
          fi
          
          echo "is_hachiko_pr=$IS_HACHIKO_PR" >> $GITHUB_OUTPUT

      - name: Update migration-dashboard issue
        if: |
          (github.event_name == 'pull_request' && (steps.handle-pr.outputs.is_hachiko_pr == 'true' || steps.handle-pr-closure.outputs.is_hachiko_pr == 'true')) || 
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issues' && github.event.issue.number == fromJson(steps.find-issue.outputs.migration_dashboard_issue))
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.find-issue.outputs.migration_dashboard_issue }}
        run: |
          echo "Updating migration-dashboard issue #$ISSUE_NUMBER"

          # If migrations were triggered, wait a moment for them to start
          if [ "${{ github.event_name }}" = "issues" ] && [ "${{ steps.handle-edit.outputs.migrations_triggered }}" = "true" ]; then
            echo "Migrations were triggered, waiting 30 seconds for workflows to start before updating dashboard..."
            sleep 30
          fi

          # Use the migration CLI script to generate the dashboard content
          ISSUE_BODY=$(pnpm migration generate-migration-dashboard)

          # Update the issue
          echo "$ISSUE_BODY" | gh issue edit "$ISSUE_NUMBER" --body-file -

          echo "Migration-dashboard issue updated successfully"
