name: Migration Dashboard Manager

# Trigger on migration-dashboard issue edits and PR events
on:
  issues:
    types: [edited]
  pull_request:
    types: [opened, synchronize, closed]

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - "update_issue"
          - "start_migration"
          - "pause_migration"
      verbose:
        description: "Enable verbose debugging output"
        required: false
        type: boolean
        default: false

permissions:
  contents: write # To create PRs and update files
  issues: write # To update migration-dashboard issue
  pull-requests: write # To create and manage PRs
  actions: write # To trigger workflow dispatches

# Prevent concurrent executions to avoid double-triggering migrations
concurrency:
  group: migration-dashboard-${{ github.repository }}
  cancel-in-progress: false # Queue instead of cancelling to avoid losing checkbox changes

jobs:
  handle-migration-dashboard:
    name: Handle Migration Dashboard Event
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.3
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: |
          pnpm install
          pnpm build

      - name: Setup verbose mode
        id: setup-verbose
        run: |
          # Enable verbose mode if requested or if triggered manually
          VERBOSE="${{ inputs.verbose }}"

          # Default to false for webhook triggers
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            VERBOSE="false"
          fi

          echo "verbose=$VERBOSE" >> $GITHUB_OUTPUT

          if [ "$VERBOSE" = "true" ]; then
            echo "üîç VERBOSE MODE ENABLED"
            echo "============================================"
            echo "Workflow Run ID: ${{ github.run_id }}"
            echo "Workflow Run Number: ${{ github.run_number }}"
            echo "Event: ${{ github.event_name }}"
            echo "Triggered by: ${{ github.actor }}"
            echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            echo "============================================"
          fi

      - name: Identify migration-dashboard issue
        id: find-issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find or create the migration-dashboard issue
          ISSUE_NUMBER=$(gh issue list --label "hachiko:migration-dashboard" --json number --jq '.[0].number // empty')

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "Creating migration-dashboard issue..."
            ISSUE_URL=$(gh issue create \
              --title "üìä Hachiko Migration Dashboard" \
              --label "hachiko:migration-dashboard" \
              --body "$(cat <<'EOF'
          # üìä Hachiko Migration Dashboard

          This issue tracks all active migrations in the repository. Use the checkboxes below to control migration execution.

          ## üü° Pending Migrations

          ‚ú® *No pending migrations*

          ## üîÑ In-Progress Migrations

          ‚ú® *No active migrations*

          ## ‚è∏Ô∏è Paused Migrations

          ‚ú® *No paused migrations*

          ---

          **How to use:**
          - ‚úÖ Check a box next to a pending migration to start it
          - ‚úÖ Check a box next to a paused migration to resume it
          - ‚ùå Closing a Hachiko PR will pause the migration
          - üîÑ This dashboard updates automatically as migrations progress

          ü§ñ *Managed by Hachiko - Do not edit the sections above manually*
          EOF
          )")
            ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -o '[0-9]*$')
          fi

          echo "migration_dashboard_issue=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "Found/created migration-dashboard issue #$ISSUE_NUMBER"

      - name: Handle issue edit
        if: github.event_name == 'issues' && github.event.issue.number == fromJson(steps.find-issue.outputs.migration_dashboard_issue)
        id: handle-edit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "Migration-dashboard issue edited"

          # Parse the issue body to detect checkbox changes
          ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body')

          # Extract checked migrations from Pending section
          CHECKED_PENDING=$(echo "$ISSUE_BODY" | awk '/## üü° Pending Migrations/,/## üîÑ In-Progress Migrations/ { if (/^- \[x\]/) print }' | sed 's/^- \[x\] `//' | sed 's/`.*$//')

          # Extract checked migrations from In-Progress section (for triggering next step)
          CHECKED_IN_PROGRESS=$(echo "$ISSUE_BODY" | awk '/## üîÑ In-Progress Migrations/,/## ‚è∏Ô∏è Paused Migrations/ { if (/^- \[x\]/) print }' | sed 's/^- \[x\] `//' | sed 's/`.*$//')

          # Extract checked migrations from Paused section  
          CHECKED_PAUSED=$(echo "$ISSUE_BODY" | awk '/## ‚è∏Ô∏è Paused Migrations/,/---/ { if (/^- \[x\]/) print }' | sed 's/^- \[x\] `//' | sed 's/`.*$//')

          # Extract restart requests from In-Progress section (nested checkboxes like "- [ ] Start step X")
          RESTART_REQUESTS=$(echo "$ISSUE_BODY" | awk '
            /## üîÑ In-Progress Migrations/,/## ‚è∏Ô∏è Paused Migrations/ {
              if (/^    - \[x\] Start step/) {
                # Extract step number
                gsub(/.*Start step /, "")
                gsub(/[^0-9].*/, "")
                step = $0
                
                # Find the migration ID from the previous lines
                for (i = NR-10; i < NR; i++) {
                  if (lines[i] ~ /^- `[^`]+` - /) {
                    gsub(/^- `/, "", lines[i])
                    gsub(/` - .*/, "", lines[i])
                    print lines[i] ":" step
                    break
                  }
                }
              }
              lines[NR] = $0
            }
          ')

          # Helper function to check if migration is already running
          check_migration_running() {
            local migration_id="$1"
            # Check for running execute-migration workflows for this migration
            RUNNING_COUNT=$(gh run list --workflow=execute-migration.yml --status=in_progress --json conclusion | jq 'length')
            if [ "$RUNNING_COUNT" -gt 0 ]; then
              echo "‚ö†Ô∏è Execution workflow already running - skipping trigger for $migration_id"
              return 0
            fi
            return 1
          }

          # Process checked migrations from Pending section (restart from current step)
          MIGRATIONS_TRIGGERED=false
          for MIGRATION_ID in $CHECKED_PENDING; do
            if [ -n "$MIGRATION_ID" ] && [ "$MIGRATION_ID" != "‚ú®" ]; then
              echo "Starting pending migration: $MIGRATION_ID"
              
              # Check if migration is already running
              if check_migration_running "$MIGRATION_ID"; then
                continue
              fi
              
              # For pending migrations, start from step 1
              CURRENT_STEP=1
              echo "Migration $MIGRATION_ID starting at step: $CURRENT_STEP"
              
              # Trigger migration execution
              gh workflow run execute-migration.yml \
                -f migration_id="$MIGRATION_ID" \
                -f step_id="$CURRENT_STEP"
              
              MIGRATIONS_TRIGGERED=true
            fi
          done

          # Process checked migrations from Paused section (resume from current step)
          for MIGRATION_ID in $CHECKED_PAUSED; do
            if [ -n "$MIGRATION_ID" ] && [ "$MIGRATION_ID" != "‚ú®" ]; then
              echo "Resuming paused migration: $MIGRATION_ID"

              # Check if migration is already running
              if check_migration_running "$MIGRATION_ID"; then
                continue
              fi

              # Get total steps from migration file
              MIGRATION_FILE="migrations/${MIGRATION_ID}.md"
              TOTAL_STEPS=0
              if [ -f "$MIGRATION_FILE" ]; then
                TOTAL_STEPS=$(awk '/^---$/{if(f==1) exit; f=1; next} f' "$MIGRATION_FILE" | grep "^total_steps:" | sed 's/total_steps: *//')
              fi

              # Get the most recent closed PR for this migration to check if it's a cleanup PR
              MOST_RECENT_CLOSED_PR=$(gh pr list --repo "${{ github.repository }}" --state closed --search "head:hachiko/${MIGRATION_ID}" --limit 1 --json number,headRefName --jq '.[0]')

              STEP_TO_RESUME=""
              if [ -n "$MOST_RECENT_CLOSED_PR" ]; then
                CLOSED_PR_BRANCH=$(echo "$MOST_RECENT_CLOSED_PR" | jq -r '.headRefName')
                echo "Most recent closed PR branch: $CLOSED_PR_BRANCH"

                # Check if it's a cleanup PR (branch contains "cleanup" or step number > total_steps)
                if [[ "$CLOSED_PR_BRANCH" =~ cleanup|final ]]; then
                  echo "Detected cleanup PR from branch name"
                  STEP_TO_RESUME="cleanup"
                elif [[ "$CLOSED_PR_BRANCH" =~ -step-([0-9]+) ]]; then
                  STEP_NUM="${BASH_REMATCH[1]}"
                  if [ "$TOTAL_STEPS" -gt 0 ] && [ "$STEP_NUM" -gt "$TOTAL_STEPS" ]; then
                    echo "Detected cleanup PR: step $STEP_NUM exceeds total_steps $TOTAL_STEPS"
                    STEP_TO_RESUME="cleanup"
                  fi
                fi
              fi

              # If not determined to be cleanup, calculate step from state
              if [ -z "$STEP_TO_RESUME" ]; then
                echo "üîç Calculating current step for $MIGRATION_ID from PR activity..."
                STATE_OUTPUT=$(GITHUB_TOKEN="${GITHUB_TOKEN}" GITHUB_REPOSITORY="${GITHUB_REPOSITORY}" node dist/scripts/get-migration-state.js "$MIGRATION_ID" 2>/dev/null || echo "")

                if [ -n "$STATE_OUTPUT" ]; then
                  CURRENT_STEP=$(echo "$STATE_OUTPUT" | grep "^current_step=" | cut -d'=' -f2)

                  # Check if calculated step exceeds total_steps (indicates cleanup)
                  if [ "$TOTAL_STEPS" -gt 0 ] && [ "$CURRENT_STEP" -gt "$TOTAL_STEPS" ]; then
                    echo "Calculated step $CURRENT_STEP exceeds total_steps $TOTAL_STEPS - treating as cleanup"
                    STEP_TO_RESUME="cleanup"
                  else
                    STEP_TO_RESUME="$CURRENT_STEP"
                    echo "Migration $MIGRATION_ID resuming at step: $STEP_TO_RESUME (calculated from PR activity)"
                  fi
                else
                  echo "‚ö†Ô∏è Could not calculate step from PR activity, falling back to migration file"
                  if [ -f "$MIGRATION_FILE" ]; then
                    CURRENT_STEP=$(awk '/^---$/{if(f==1) exit; f=1; next} f' "$MIGRATION_FILE" | grep "^current_step:" | sed 's/current_step: *//')
                    # Default to step 1 if not found or invalid
                    if ! [[ "$CURRENT_STEP" =~ ^[0-9]+$ ]] || [ "$CURRENT_STEP" -lt 1 ]; then
                      CURRENT_STEP=1
                    fi
                    STEP_TO_RESUME="$CURRENT_STEP"
                    echo "Migration $MIGRATION_ID resuming at step: $STEP_TO_RESUME (from frontmatter)"
                  else
                    echo "Warning: Migration file not found, defaulting to step 1"
                    STEP_TO_RESUME=1
                  fi
                fi
              fi

              # Trigger migration execution
              echo "Triggering migration execution: migration_id=$MIGRATION_ID, step_id=$STEP_TO_RESUME"
              gh workflow run execute-migration.yml \
                -f migration_id="$MIGRATION_ID" \
                -f step_id="$STEP_TO_RESUME"

              MIGRATIONS_TRIGGERED=true
            fi
          done

          # Process checked migrations from In-Progress section (advance to next step)
          for MIGRATION_ID in $CHECKED_IN_PROGRESS; do
            if [ -n "$MIGRATION_ID" ] && [ "$MIGRATION_ID" != "‚ú®" ]; then
              echo "Advancing in-progress migration: $MIGRATION_ID"
              
              # Check if migration is already running
              if check_migration_running "$MIGRATION_ID"; then
                continue
              fi
              
              # Get current step from calculated state (preferred) or fallback to migration file
              echo "üîç Calculating current step for $MIGRATION_ID from PR activity..."
              STATE_OUTPUT=$(GITHUB_TOKEN="${GITHUB_TOKEN}" GITHUB_REPOSITORY="${GITHUB_REPOSITORY}" node dist/scripts/get-migration-state.js "$MIGRATION_ID" 2>/dev/null || echo "")
              
              if [ -n "$STATE_OUTPUT" ]; then
                CURRENT_STEP=$(echo "$STATE_OUTPUT" | grep "^current_step=" | cut -d'=' -f2)
                NEXT_STEP=$((CURRENT_STEP + 1))
                echo "Migration $MIGRATION_ID advancing from step $CURRENT_STEP to step $NEXT_STEP (calculated from PR activity)"
              else
                echo "‚ö†Ô∏è Could not calculate step from PR activity, falling back to migration file"
                MIGRATION_FILE="migrations/${MIGRATION_ID}.md"
                if [ -f "$MIGRATION_FILE" ]; then
                  CURRENT_STEP=$(awk '/^---$/{if(f==1) exit; f=1; next} f' "$MIGRATION_FILE" | grep "^current_step:" | sed 's/current_step: *//')
                  # Default to step 1 if not found or invalid
                  if ! [[ "$CURRENT_STEP" =~ ^[0-9]+$ ]] || [ "$CURRENT_STEP" -lt 1 ]; then
                    CURRENT_STEP=1
                  fi
                  NEXT_STEP=$((CURRENT_STEP + 1))
                  echo "Migration $MIGRATION_ID advancing from step $CURRENT_STEP to step $NEXT_STEP (from frontmatter)"
                else
                  echo "Warning: Migration file not found, defaulting to next step as step 2"
                  NEXT_STEP=2
                fi
              fi
              
              # Trigger migration execution with next step
              gh workflow run execute-migration.yml \
                -f migration_id="$MIGRATION_ID" \
                -f step_id="$NEXT_STEP"
              
              MIGRATIONS_TRIGGERED=true
            fi
          done

          # Process restart requests from In-Progress section
          if [ -n "$RESTART_REQUESTS" ]; then
            echo "$RESTART_REQUESTS" | while IFS=':' read -r MIGRATION_ID STEP_ID; do
              if [ -n "$MIGRATION_ID" ] && [ -n "$STEP_ID" ]; then
                echo "Manually restarting migration: $MIGRATION_ID at step $STEP_ID"
                
                # Check if migration is already running
                if check_migration_running "$MIGRATION_ID"; then
                  continue
                fi
                
                # Trigger migration execution with specified step
                gh workflow run execute-migration.yml \
                  -f migration_id="$MIGRATION_ID" \
                  -f step_id="$STEP_ID"
                
                MIGRATIONS_TRIGGERED=true
              fi
            done
          fi

          # Set output for conditional issue update
          echo "migrations_triggered=$MIGRATIONS_TRIGGERED" >> $GITHUB_OUTPUT

      - name: Handle PR opened/updated
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize')
        id: handle-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          VERBOSE: ${{ steps.setup-verbose.outputs.verbose }}
        run: |
          echo "PR ${{ github.event.action }}: $PR_TITLE"
          echo "Branch: $PR_BRANCH"

          if [ "$VERBOSE" = "true" ]; then
            echo ""
            echo "üîç [VERBOSE] PR Detection - Starting"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "PR Number: $PR_NUMBER"
            echo "PR Action: ${{ github.event.action }}"
            echo "PR Branch: $PR_BRANCH"
            echo "PR Title: $PR_TITLE"
            echo "PR Author: ${{ github.event.pull_request.user.login }}"
            echo ""
            echo "Will attempt detection via:"
            echo "  1. Branch name (hachiko/* pattern)"
            echo "  2. Tracking token in PR body/commits"
            echo "  3. Agent branch + recent dispatch correlation"
            echo "  4. Label-based detection"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          fi

          # Check if this is a Hachiko migration PR using multiple detection paths
          IS_HACHIKO_PR=false
          DETECTED_MIGRATION_ID=""

          # Path 1: Branch name (existing - for well-behaved agents)
          if [[ "$PR_BRANCH" == hachiko/* ]]; then
            IS_HACHIKO_PR=true
            DETECTED_MIGRATION_ID=$(echo "$PR_BRANCH" | sed 's|hachiko/||' | sed 's/-step-[0-9]*//' | sed 's/-cleanup.*//' | sed 's/-status-update.*//')
            echo "‚úÖ Hachiko migration PR detected by branch name: $PR_BRANCH"
            [ "$VERBOSE" = "true" ] && echo "üîç [VERBOSE] Path 1 SUCCESS - Migration ID: $DETECTED_MIGRATION_ID"

          # Path 2: Tracking token in commits or PR body
          elif TRACKING_TOKEN=$(gh pr view "$PR_NUMBER" --json body,commits \
              --jq '[.body, (.commits[]?.messageHeadline // empty)] | join("\n")' 2>/dev/null \
              | grep -oEm1 'hachiko-track:[^[:space:]:]+:[^[:space:]:]+'); then
            IS_HACHIKO_PR=true
            DETECTED_MIGRATION_ID=$(echo "$TRACKING_TOKEN" | cut -d: -f2)
            echo "‚úÖ Hachiko migration PR detected by tracking token: $TRACKING_TOKEN"
            [ "$VERBOSE" = "true" ] && echo "üîç [VERBOSE] Path 2 SUCCESS - Migration ID: $DETECTED_MIGRATION_ID"

          # Path 3: Known agent branch pattern + recent dispatch correlation
          elif [[ "$PR_BRANCH" == cursor/* ]] || [[ "$PR_BRANCH" == devin/* ]]; then
            [ "$VERBOSE" = "true" ] && echo "üîç [VERBOSE] Path 3 - Agent branch detected, checking recent dispatches..."

            RECENT_DISPATCH=$(gh run list --workflow=execute-migration.yml --limit=5 \
              --json name,status,createdAt \
              --jq '[.[] | select(.status == "completed" or .status == "in_progress")]
                    | sort_by(.createdAt) | reverse | .[0].name // empty' 2>/dev/null)

            if [ "$VERBOSE" = "true" ]; then
              echo "üîç [VERBOSE] Recent dispatch: ${RECENT_DISPATCH:-<none>}"
            fi

            if [ -n "$RECENT_DISPATCH" ]; then
              DETECTED_MIGRATION_ID=$(echo "$RECENT_DISPATCH" | sed 's/Execute: //' | sed 's/ step .*//')
              if [ -n "$DETECTED_MIGRATION_ID" ]; then
                IS_HACHIKO_PR=true
                echo "‚úÖ Hachiko migration PR detected by agent branch + dispatch correlation: $DETECTED_MIGRATION_ID"
                [ "$VERBOSE" = "true" ] && echo "üîç [VERBOSE] Path 3 SUCCESS - Migration ID: $DETECTED_MIGRATION_ID"
              else
                [ "$VERBOSE" = "true" ] && echo "üîç [VERBOSE] Path 3 FAILED - Could not extract migration ID from dispatch"
              fi
            else
              [ "$VERBOSE" = "true" ] && echo "üîç [VERBOSE] Path 3 FAILED - No recent dispatches found"
            fi

          # Path 4: Label-based detection (existing fallback)
          elif gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' 2>/dev/null | grep -q "hachiko:migration"; then
            IS_HACHIKO_PR=true
            echo "‚úÖ Hachiko migration PR detected by label"
            [ "$VERBOSE" = "true" ] && echo "üîç [VERBOSE] Path 4 SUCCESS - Label-based detection (no migration ID extracted)"
          else
            [ "$VERBOSE" = "true" ] && echo "üîç [VERBOSE] All detection paths FAILED"
          fi

          # Validate detected migration ID corresponds to a real migration file
          if [ "$IS_HACHIKO_PR" = "true" ] && [ -n "$DETECTED_MIGRATION_ID" ] && [[ "$PR_BRANCH" != hachiko/* ]]; then
            if [ ! -f "migrations/${DETECTED_MIGRATION_ID}.md" ]; then
              echo "‚ö†Ô∏è Detected migration ID '${DETECTED_MIGRATION_ID}' has no migration file - ignoring"
              IS_HACHIKO_PR=false
              DETECTED_MIGRATION_ID=""
            fi
          fi

          if [ "$IS_HACHIKO_PR" = "false" ]; then
            echo "‚ÑπÔ∏è Not a Hachiko migration PR - no dashboard update needed"
          fi

          # Normalize agent PRs that don't use hachiko/* branch naming
          if [ "$IS_HACHIKO_PR" = "true" ] && [[ "$PR_BRANCH" != hachiko/* ]] && [ -n "$DETECTED_MIGRATION_ID" ]; then
            # Skip if already normalized (check for existing tracking comment)
            if gh pr view "$PR_NUMBER" --json comments --jq '.comments[].body' 2>/dev/null | grep -q "hachiko-track:${DETECTED_MIGRATION_ID}"; then
              echo "‚ÑπÔ∏è PR #$PR_NUMBER already normalized for migration: $DETECTED_MIGRATION_ID"
            else
              echo "üîÑ Normalizing agent PR #$PR_NUMBER for migration: $DETECTED_MIGRATION_ID"
              gh pr edit "$PR_NUMBER" --add-label "hachiko:migration" 2>/dev/null || true
              gh pr comment "$PR_NUMBER" --body "<!-- hachiko-track:${DETECTED_MIGRATION_ID} -->
          ü§ñ **Hachiko Migration Tracking**
          This PR has been linked to migration \`${DETECTED_MIGRATION_ID}\`.
          Branch naming was auto-detected from agent output." 2>/dev/null || true
            fi
          fi

          echo "is_hachiko_pr=$IS_HACHIKO_PR" >> $GITHUB_OUTPUT

          # If this is a Hachiko migration PR being opened, it means a migration just started
          if [ "$IS_HACHIKO_PR" = "true" ] && [ "${{ github.event.action }}" = "opened" ]; then
            echo "üöÄ Migration PR opened - this indicates migration execution started"
            echo "üìä Dashboard will be updated to reflect the new in-progress migration"
          fi

      - name: Handle PR closure
        if: github.event_name == 'pull_request' && github.event.pull_request.state == 'closed'
        id: handle-pr-closure
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_MERGED: ${{ github.event.pull_request.merged }}
          VERBOSE: ${{ steps.setup-verbose.outputs.verbose }}
        run: |
          echo "PR closed: $PR_TITLE"
          echo "Branch: $PR_BRANCH"
          echo "Merged: $PR_MERGED"

          if [ "$VERBOSE" = "true" ]; then
            echo ""
            echo "üîç [VERBOSE] PR Closure Detection - Starting"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "PR Number: ${{ github.event.pull_request.number }}"
            echo "PR Branch: $PR_BRANCH"
            echo "PR Title: $PR_TITLE"
            echo "PR Merged: $PR_MERGED"
            echo "PR Closed At: ${{ github.event.pull_request.closed_at }}"
            echo ""
            echo "Attempting detection to determine migration action..."
            echo "  - If merged: advance migration"
            echo "  - If not merged: pause migration"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          fi

          IS_HACHIKO_PR=false
          MIGRATION_ID=""

          # Path 1: Branch name (existing - for well-behaved agents)
          if [[ "$PR_BRANCH" == hachiko/* ]]; then
            IS_HACHIKO_PR=true
            MIGRATION_ID=$(echo "$PR_BRANCH" | sed 's/hachiko\///' | sed 's/-step-[0-9]*//' | sed 's/-cleanup.*//' | sed 's/-final.*//' | sed 's/-devin.*//' | sed 's/-cursor.*//' | sed 's/-v[0-9].*//')

          # Path 2: Tracking token in PR body or commits
          elif TRACKING_TOKEN=$(gh pr view "${{ github.event.pull_request.number }}" --json body,commits \
              --jq '[.body, (.commits[]?.messageHeadline // empty)] | join("\n")' 2>/dev/null \
              | grep -oEm1 'hachiko-track:[^[:space:]:]+:[^[:space:]:]+'); then
            IS_HACHIKO_PR=true
            MIGRATION_ID=$(echo "$TRACKING_TOKEN" | cut -d: -f2)

          # Path 3: Known agent branch pattern + recent dispatch correlation
          elif [[ "$PR_BRANCH" == cursor/* ]] || [[ "$PR_BRANCH" == devin/* ]]; then
            RECENT_DISPATCH=$(gh run list --workflow=execute-migration.yml --limit=5 \
              --json name,status,createdAt \
              --jq '[.[] | select(.status == "completed" or .status == "in_progress")]
                    | sort_by(.createdAt) | reverse | .[0].name // empty' 2>/dev/null)

            if [ -n "$RECENT_DISPATCH" ]; then
              MIGRATION_ID=$(echo "$RECENT_DISPATCH" | sed 's/Execute: //' | sed 's/ step .*//')
              if [ -n "$MIGRATION_ID" ]; then
                IS_HACHIKO_PR=true
              fi
            fi

          # Path 4: Label-based detection
          elif gh pr view "${{ github.event.pull_request.number }}" --json labels --jq '.labels[].name' 2>/dev/null | grep -q "hachiko:migration"; then
            IS_HACHIKO_PR=true
          fi

          # Validate detected migration ID corresponds to a real migration file
          if [ "$IS_HACHIKO_PR" = "true" ] && [ -n "$MIGRATION_ID" ] && [[ "$PR_BRANCH" != hachiko/* ]]; then
            if [ ! -f "migrations/${MIGRATION_ID}.md" ]; then
              echo "‚ö†Ô∏è Detected migration ID '${MIGRATION_ID}' has no migration file - ignoring"
              IS_HACHIKO_PR=false
              MIGRATION_ID=""
            fi
          fi

          if [ "$IS_HACHIKO_PR" = "true" ] && [ -n "$MIGRATION_ID" ]; then
            echo "Hachiko migration PR detected: $MIGRATION_ID"

            if [ "$PR_MERGED" = "true" ]; then
              echo "PR was merged - advancing migration"
              ./scripts/advance-migration.sh "$MIGRATION_ID"
            else
              echo "PR was closed without merging - pausing migration"
              ./scripts/pause-migration.sh "$MIGRATION_ID"
            fi
          fi

          echo "is_hachiko_pr=$IS_HACHIKO_PR" >> $GITHUB_OUTPUT

      - name: Update migration-dashboard issue
        if: |
          (github.event_name == 'pull_request' && (steps.handle-pr.outputs.is_hachiko_pr == 'true' || steps.handle-pr-closure.outputs.is_hachiko_pr == 'true')) ||
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issues' && github.event.issue.number == fromJson(steps.find-issue.outputs.migration_dashboard_issue))
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.find-issue.outputs.migration_dashboard_issue }}
          VERBOSE: ${{ steps.setup-verbose.outputs.verbose }}
        run: |
          if [ "$VERBOSE" = "true" ]; then
            echo ""
            echo "üîç [VERBOSE] Dashboard Update - Starting"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Issue Number: $ISSUE_NUMBER"
            echo "Event Type: ${{ github.event_name }}"
            echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            echo ""
            echo "Trigger Reason:"
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "  - PR Event (opened/closed)"
              echo "  - PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
            elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "  - Manual Trigger"
              echo "  - Action: ${{ inputs.action }}"
            elif [ "${{ github.event_name }}" = "issues" ]; then
              echo "  - Issue Edited (checkbox clicked)"
            fi
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
          fi

          echo "Updating migration-dashboard issue #$ISSUE_NUMBER"

          # If migrations were triggered, wait a moment for them to start
          if [ "${{ github.event_name }}" = "issues" ] && [ "${{ steps.handle-edit.outputs.migrations_triggered }}" = "true" ]; then
            echo "Migrations were triggered, waiting 30 seconds for workflows to start before updating dashboard..."
            sleep 30
          fi

          # Check for concurrent runs
          if [ "$VERBOSE" = "true" ]; then
            echo "üîç [VERBOSE] Checking for concurrent workflow runs..."
            CONCURRENT_RUNS=$(gh run list --workflow=migration-dashboard.yml --json status,databaseId,createdAt --jq '[.[] | select(.status == "in_progress" or .status == "queued")] | length')
            echo "üîç [VERBOSE] Concurrent/queued runs: $CONCURRENT_RUNS"
            if [ "$CONCURRENT_RUNS" -gt 1 ]; then
              echo "‚ö†Ô∏è [VERBOSE] WARNING: Multiple runs detected - potential race condition"
              gh run list --workflow=migration-dashboard.yml --limit=5 --json status,databaseId,createdAt,displayTitle
            fi
          fi

          # Use the migration CLI script to generate the dashboard content
          # Capture both stdout (dashboard) and stderr (cleanup info)
          if [ "$VERBOSE" = "true" ]; then
            echo "üîç [VERBOSE] Generating dashboard content..."
          fi

          DASHBOARD_OUTPUT=$(pnpm --silent migration generate-migration-dashboard 2>&1)
          ISSUE_BODY=$(echo "$DASHBOARD_OUTPUT" | grep -v "CLEANUP_NEEDED=")
          CLEANUP_NEEDED=$(echo "$DASHBOARD_OUTPUT" | grep "CLEANUP_NEEDED=" | sed 's/CLEANUP_NEEDED=//' || echo "")

          # ALWAYS log migration grouping summary (not just in verbose mode)
          echo "üìä Dashboard Generation Summary"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          PENDING_COUNT=$(echo "$ISSUE_BODY" | awk '/## üü° Pending Migrations/,/## üîÑ In-Progress Migrations/ { if (/^- \[/) count++ } END { print count+0 }')
          IN_PROGRESS_COUNT=$(echo "$ISSUE_BODY" | awk '/## üîÑ In-Progress Migrations/,/## ‚è∏Ô∏è Paused Migrations/ { if (/^- \[/) count++ } END { print count+0 }')
          PAUSED_COUNT=$(echo "$ISSUE_BODY" | awk '/## ‚è∏Ô∏è Paused Migrations/,/---/ { if (/^- \[/) count++ } END { print count+0 }')
          echo "  Pending: $PENDING_COUNT migrations"
          echo "  In-Progress: $IN_PROGRESS_COUNT migrations"
          echo "  Paused: $PAUSED_COUNT migrations"

          # Show which migrations are in-progress (critical info)
          if [ "$IN_PROGRESS_COUNT" -gt 0 ]; then
            echo ""
            echo "In-Progress migrations:"
            echo "$ISSUE_BODY" | awk '/## üîÑ In-Progress Migrations/,/## ‚è∏Ô∏è Paused Migrations/ { if (/^- \[/) print "  - " $0 }' | sed 's/- \[ \] `//' | sed 's/`.*//'
          fi
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""

          if [ "$VERBOSE" = "true" ]; then
            echo "üîç [VERBOSE] Dashboard Content Generated"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Content length: $(echo "$ISSUE_BODY" | wc -c) bytes"
            echo "Content lines: $(echo "$ISSUE_BODY" | wc -l) lines"
            echo ""
            echo "First 30 lines of generated content:"
            echo "$ISSUE_BODY" | head -30
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""

            # Check for specific migrations
            echo "üîç [VERBOSE] Checking for specific migrations in content:"
            for migration_file in migrations/*.md; do
              if [ -f "$migration_file" ]; then
                MIGRATION_ID=$(basename "$migration_file" .md)
                if echo "$ISSUE_BODY" | grep -q "$MIGRATION_ID"; then
                  echo "  ‚úÖ Found: $MIGRATION_ID"
                else
                  echo "  ‚ùå Missing: $MIGRATION_ID"
                fi
              fi
            done
            echo ""
          fi

          # Save content to temp file for debugging
          if [ "$VERBOSE" = "true" ]; then
            echo "$ISSUE_BODY" > /tmp/dashboard-update-${{ github.run_id }}.txt
            echo "üîç [VERBOSE] Saved dashboard content to /tmp/dashboard-update-${{ github.run_id }}.txt"
          fi

          # Update the issue
          echo "Executing: gh issue edit $ISSUE_NUMBER --body-file -"

          echo "$ISSUE_BODY" | gh issue edit "$ISSUE_NUMBER" --body-file -
          UPDATE_EXIT_CODE=$?

          echo "gh issue edit exit code: $UPDATE_EXIT_CODE"

          if [ $UPDATE_EXIT_CODE -ne 0 ]; then
            echo "‚ùå ERROR: Failed to update issue (exit code: $UPDATE_EXIT_CODE)"
            exit 1
          fi

          echo "Migration-dashboard issue updated successfully (exit code: $UPDATE_EXIT_CODE)"

          # ALWAYS verify the update (not just in verbose mode)
          echo ""
          echo "üîç Verifying Update"
          echo "Waiting 2 seconds for API consistency..."
          sleep 2

          CURRENT_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body')
          CURRENT_UPDATED_AT=$(gh issue view "$ISSUE_NUMBER" --json updatedAt --jq '.updatedAt')

          echo "Issue last updated at: $CURRENT_UPDATED_AT"

          # ALWAYS check if in-progress migrations persisted
          ACTUAL_IN_PROGRESS_COUNT=$(echo "$CURRENT_BODY" | awk '/## üîÑ In-Progress Migrations/,/## ‚è∏Ô∏è Paused Migrations/ { if (/^- \[/) count++ } END { print count+0 }')

          echo ""
          echo "Verification Results:"
          echo "  Expected in-progress: $IN_PROGRESS_COUNT"
          echo "  Actual in-progress: $ACTUAL_IN_PROGRESS_COUNT"

          if [ "$IN_PROGRESS_COUNT" -ne "$ACTUAL_IN_PROGRESS_COUNT" ]; then
            echo ""
            echo "‚ö†Ô∏è  WARNING: Mismatch detected!"
            echo "    Expected $IN_PROGRESS_COUNT in-progress migrations but found $ACTUAL_IN_PROGRESS_COUNT"
            echo "    This indicates the update may not have persisted correctly."

            # Show which in-progress migrations we expected vs what's actually there
            if [ "$IN_PROGRESS_COUNT" -gt 0 ]; then
              echo ""
              echo "Expected in-progress migrations:"
              echo "$ISSUE_BODY" | awk '/## üîÑ In-Progress Migrations/,/## ‚è∏Ô∏è Paused Migrations/ { if (/^- \[/) print "  - " $0 }' | sed 's/- \[ \] `//' | sed 's/`.*//'
            fi

            if [ "$ACTUAL_IN_PROGRESS_COUNT" -gt 0 ]; then
              echo ""
              echo "Actual in-progress migrations in issue:"
              echo "$CURRENT_BODY" | awk '/## üîÑ In-Progress Migrations/,/## ‚è∏Ô∏è Paused Migrations/ { if (/^- \[/) print "  - " $0 }' | sed 's/- \[ \] `//' | sed 's/`.*//'
            fi
          else
            echo "  ‚úÖ Verification passed - counts match"
          fi
          echo ""

          # In verbose mode, show detailed per-migration verification
          if [ "$VERBOSE" = "true" ]; then
            echo "üîç [VERBOSE] Detailed Verification"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Checking each migration:"

            for migration_file in migrations/*.md; do
              if [ -f "$migration_file" ]; then
                MIGRATION_ID=$(basename "$migration_file" .md)
                if echo "$CURRENT_BODY" | grep -q "$MIGRATION_ID"; then
                  echo "  ‚úÖ Verified in issue: $MIGRATION_ID"
                else
                  echo "  ‚ùå NOT in issue: $MIGRATION_ID"
                  # Compare with what we sent
                  if echo "$ISSUE_BODY" | grep -q "$MIGRATION_ID"; then
                    echo "     ‚ö†Ô∏è Was in content we sent but not in issue now!"
                  fi
                fi
              fi
            done
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
          fi
          
          # Output cleanup-needed migrations for next step
          echo "cleanup_needed=$CLEANUP_NEEDED" >> $GITHUB_OUTPUT
          
          # Automatically trigger cleanup for completed migrations
          if [ -n "$CLEANUP_NEEDED" ]; then
            echo "üßπ Automatically triggering cleanup for completed migrations: $CLEANUP_NEEDED"
            for migration_id in $(echo "$CLEANUP_NEEDED" | tr ',' ' '); do
              if [ -n "$migration_id" ]; then
                echo "Triggering cleanup for migration: $migration_id"
                gh workflow run execute-migration.yml \
                  -f migration_id="$migration_id" \
                  -f step_id="cleanup" \
                  -f force="false"
              fi
            done
          else
            echo "‚ÑπÔ∏è No migrations require cleanup at this time"
          fi
