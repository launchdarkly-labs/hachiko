name: Migration Dashboard Manager

# Trigger on migration-dashboard issue edits and PR events
on:
  issues:
    types: [edited]
  pull_request:
    types: [opened, synchronize, closed]

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - "update_issue"
          - "start_migration"
          - "pause_migration"

permissions:
  contents: write # To create PRs and update files
  issues: write # To update migration-dashboard issue
  pull-requests: write # To create and manage PRs
  actions: write # To trigger workflow dispatches

jobs:
  handle-migration-dashboard:
    name: Handle Migration Dashboard Event
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.3
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: |
          pnpm install
          pnpm build

      - name: Identify migration-dashboard issue
        id: find-issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find or create the migration-dashboard issue
          ISSUE_NUMBER=$(gh issue list --label "hachiko:migration-dashboard" --json number --jq '.[0].number // empty')

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "Creating migration-dashboard issue..."
            ISSUE_URL=$(gh issue create \
              --title "ðŸ“Š Hachiko Migration Dashboard" \
              --label "hachiko:migration-dashboard" \
              --body "$(cat <<'EOF'
          # ðŸ“Š Hachiko Migration Dashboard

          This issue tracks all active migrations in the repository. Use the checkboxes below to control migration execution.

          ## ðŸŸ¡ Pending Migrations

          âœ¨ *No pending migrations*

          ## ðŸ”„ In-Progress Migrations

          âœ¨ *No active migrations*

          ## â¸ï¸ Paused Migrations

          âœ¨ *No paused migrations*

          ---

          **How to use:**
          - âœ… Check a box next to a pending migration to start it
          - âœ… Check a box next to a paused migration to resume it
          - âŒ Closing a Hachiko PR will pause the migration
          - ðŸ”„ This dashboard updates automatically as migrations progress

          ðŸ¤– *Managed by Hachiko - Do not edit the sections above manually*
          EOF
          )")
            ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -o '[0-9]*$')
          fi

          echo "migration_dashboard_issue=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "Found/created migration-dashboard issue #$ISSUE_NUMBER"

      - name: Handle issue edit
        if: github.event_name == 'issues' && github.event.issue.number == fromJson(steps.find-issue.outputs.migration_dashboard_issue)
        id: handle-edit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "Migration-dashboard issue edited"

          # Parse the issue body to detect checkbox changes
          ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body')

          # Extract checked migrations from Pending section
          CHECKED_PENDING=$(echo "$ISSUE_BODY" | awk '/## ðŸŸ¡ Pending Migrations/,/## ðŸ”„ In-Progress Migrations/ { if (/^- \[x\]/) print }' | sed 's/^- \[x\] `//' | sed 's/`.*$//')

          # Extract checked migrations from Paused section  
          CHECKED_PAUSED=$(echo "$ISSUE_BODY" | awk '/## â¸ï¸ Paused Migrations/,/---/ { if (/^- \[x\]/) print }' | sed 's/^- \[x\] `//' | sed 's/`.*$//')

          # Process checked migrations
          MIGRATIONS_TRIGGERED=false
          for MIGRATION_ID in $CHECKED_PENDING $CHECKED_PAUSED; do
            if [ -n "$MIGRATION_ID" ] && [ "$MIGRATION_ID" != "âœ¨" ]; then
              echo "Starting migration: $MIGRATION_ID"
              
              # Trigger migration execution
              gh workflow run execute-migration.yml \
                -f migration_id="$MIGRATION_ID" \
                -f step_id="1"
              
              MIGRATIONS_TRIGGERED=true
            fi
          done

          # Set output for conditional issue update
          echo "migrations_triggered=$MIGRATIONS_TRIGGERED" >> $GITHUB_OUTPUT

      - name: Handle PR opened/updated
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize')
        id: handle-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "PR ${{ github.event.action }}: $PR_TITLE"
          echo "Branch: $PR_BRANCH"

          # Check if this is a Hachiko migration PR (by branch or label)
          IS_HACHIKO_PR=false
          if [[ "$PR_BRANCH" == hachiko/* ]]; then
            IS_HACHIKO_PR=true
            echo "âœ… Hachiko migration PR detected by branch name: $PR_BRANCH"
          elif gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' | grep -q "hachiko:migration"; then
            IS_HACHIKO_PR=true
            echo "âœ… Hachiko migration PR detected by label"
          else
            echo "â„¹ï¸ Not a Hachiko migration PR - no dashboard update needed"
          fi

          echo "is_hachiko_pr=$IS_HACHIKO_PR" >> $GITHUB_OUTPUT

          # If this is a Hachiko migration PR being opened, it means a migration just started
          if [ "$IS_HACHIKO_PR" = "true" ] && [ "${{ github.event.action }}" = "opened" ]; then
            echo "ðŸš€ Migration PR opened - this indicates migration execution started"
            echo "ðŸ“Š Dashboard will be updated to reflect the new in-progress migration"
          fi

      - name: Handle PR closure
        if: github.event_name == 'pull_request' && github.event.pull_request.state == 'closed'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_MERGED: ${{ github.event.pull_request.merged }}
        run: |
          echo "PR closed: $PR_TITLE"
          echo "Branch: $PR_BRANCH"

          # Check if this is a Hachiko migration branch
          if [[ "$PR_BRANCH" == hachiko/* ]]; then
            # Extract migration ID from branch name
            MIGRATION_ID=$(echo "$PR_BRANCH" | sed 's/hachiko\///' | sed 's/-step-[0-9]*//')
            
            if [ -n "$MIGRATION_ID" ]; then
              echo "Hachiko migration branch detected: $MIGRATION_ID"
              
              if [ "$PR_MERGED" = "true" ]; then
                echo "PR was merged - advancing migration"
                # This would trigger the next step or completion
                ./scripts/advance-migration.sh "$MIGRATION_ID"
              else
                echo "PR was closed without merging - pausing migration"
                # Update migration status to paused
                ./scripts/pause-migration.sh "$MIGRATION_ID"
              fi
            fi
          fi

      - name: Update migration-dashboard issue
        if: |
          (github.event_name == 'pull_request' && steps.handle-pr.outputs.is_hachiko_pr == 'true') || 
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'issues' && github.event.issue.number == fromJson(steps.find-issue.outputs.migration_dashboard_issue) && steps.handle-edit.outputs.migrations_triggered != 'true')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.find-issue.outputs.migration_dashboard_issue }}
        run: |
          echo "Updating migration-dashboard issue #$ISSUE_NUMBER"

          # Use the migration CLI script to generate the dashboard content
          ISSUE_BODY=$(pnpm migration generate-migration-dashboard)

          # Update the issue
          echo "$ISSUE_BODY" | gh issue edit "$ISSUE_NUMBER" --body-file -

          echo "Migration-dashboard issue updated successfully"
