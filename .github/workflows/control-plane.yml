name: Control Plane Manager

# Trigger on control-plane issue edits and PR events
on:
  issues:
    types: [edited]
  pull_request:
    types: [closed]
  push:
    branches: [test-control-plane-workflow]

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - "update_issue"
          - "start_migration"
          - "pause_migration"

permissions:
  contents: write # To create PRs and update files
  issues: write # To update control-plane issue
  pull-requests: write # To create and manage PRs

jobs:
  handle-control-plane:
    name: Handle Control Plane Event
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.3
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: |
          pnpm install
          pnpm build

      - name: Identify control-plane issue
        id: find-issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find or create the control-plane issue
          ISSUE_NUMBER=$(gh issue list --label "hachiko:control-plane" --json number --jq '.[0].number // empty')

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "Creating control-plane issue..."
            ISSUE_NUMBER=$(gh issue create \
              --title "üéõÔ∏è Hachiko Migration Control Plane" \
              --label "hachiko:control-plane" \
              --body "$(cat <<'EOF'
          # üéõÔ∏è Hachiko Migration Control Plane

          This issue tracks all active migrations in the repository. Use the checkboxes below to control migration execution.

          ## üü° Pending Migrations

          ‚ú® *No pending migrations*

          ## üîÑ In-Progress Migrations

          ‚ú® *No active migrations*

          ## ‚è∏Ô∏è Paused Migrations

          ‚ú® *No paused migrations*

          ---

          **How to use:**
          - ‚úÖ Check a box next to a pending migration to start it
          - ‚úÖ Check a box next to a paused migration to resume it
          - ‚ùå Closing a Hachiko PR will pause the migration
          - üîÑ This dashboard updates automatically as migrations progress

          ü§ñ *Managed by Hachiko - Do not edit the sections above manually*
          EOF
          )" --json number --jq '.number')
          fi

          echo "control_plane_issue=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "Found/created control-plane issue #$ISSUE_NUMBER"

      - name: Handle issue edit
        if: github.event_name == 'issues' && github.event.issue.number == fromJson(steps.find-issue.outputs.control_plane_issue)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Control-plane issue edited"

          # Parse the issue body to detect checkbox changes
          ISSUE_BODY=$(gh issue view ${{ github.event.issue.number }} --json body --jq '.body')

          # Extract checked migrations from Pending section
          CHECKED_PENDING=$(echo "$ISSUE_BODY" | awk '/## üü° Pending Migrations/,/## üîÑ In-Progress Migrations/ { if (/^- \[x\]/) print }' | sed 's/^- \[x\] `//' | sed 's/`.*$//')

          # Extract checked migrations from Paused section  
          CHECKED_PAUSED=$(echo "$ISSUE_BODY" | awk '/## ‚è∏Ô∏è Paused Migrations/,/---/ { if (/^- \[x\]/) print }' | sed 's/^- \[x\] `//' | sed 's/`.*$//')

          # Process checked migrations
          for MIGRATION_ID in $CHECKED_PENDING $CHECKED_PAUSED; do
            if [ -n "$MIGRATION_ID" ] && [ "$MIGRATION_ID" != "‚ú®" ]; then
              echo "Starting migration: $MIGRATION_ID"
              
              # Trigger migration execution
              gh workflow run execute-migration.yml \
                -f migration_id="$MIGRATION_ID" \
                -f step_id="1"
            fi
          done

      - name: Handle PR closure
        if: github.event_name == 'pull_request' && github.event.pull_request.state == 'closed'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "PR closed: ${{ github.event.pull_request.title }}"
          echo "Branch: $PR_BRANCH"

          # Check if this is a Hachiko migration branch
          if [[ "$PR_BRANCH" == hachiko/* ]]; then
            # Extract migration ID from branch name
            MIGRATION_ID=$(echo "$PR_BRANCH" | sed 's/hachiko\/[^-]*-//' | sed 's/-step-[0-9]*//')
            
            if [ -n "$MIGRATION_ID" ]; then
              echo "Hachiko migration branch detected: $MIGRATION_ID"
              
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                echo "PR was merged - advancing migration"
                # This would trigger the next step or completion
                ./scripts/advance-migration.sh "$MIGRATION_ID"
              else
                echo "PR was closed without merging - pausing migration"
                # Update migration status to paused
                ./scripts/pause-migration.sh "$MIGRATION_ID"
              fi
            fi
          fi

      - name: Update control-plane issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.find-issue.outputs.control_plane_issue }}
        run: |
          echo "Updating control-plane issue #$ISSUE_NUMBER"

          # Scan migrations/ directory and build updated issue body
          PENDING_MIGRATIONS=""
          IN_PROGRESS_MIGRATIONS=""
          PAUSED_MIGRATIONS=""

          # Process all migration files
          for MIGRATION_FILE in migrations/*.md; do
            if [ ! -f "$MIGRATION_FILE" ]; then
              continue
            fi
            
            # Extract frontmatter
            FRONTMATTER=$(awk '/^---$/{if(f==1) exit; f=1; next} f' "$MIGRATION_FILE")
            
            if [ -z "$FRONTMATTER" ]; then
              continue
            fi
            
            # Parse YAML frontmatter (simplified)
            ID=$(echo "$FRONTMATTER" | grep "^id:" | sed 's/id: *//' | tr -d '"'"'"' | tr -d '"')
            TITLE=$(echo "$FRONTMATTER" | grep "^title:" | sed 's/title: *//' | tr -d '"'"'"' | tr -d '"')
            STATUS=$(echo "$FRONTMATTER" | grep "^status:" | sed 's/status: *//' | tr -d '"'"'"' | tr -d '"')
            CURRENT_STEP=$(echo "$FRONTMATTER" | grep "^current_step:" | sed 's/current_step: *//')
            TOTAL_STEPS=$(echo "$FRONTMATTER" | grep "^total_steps:" | sed 's/total_steps: *//')
            PR_NUMBER=$(echo "$FRONTMATTER" | grep "^pr_number:" | sed 's/pr_number: *//')
            
            # Build line based on status
            case "$STATUS" in
              "pending")
                PENDING_MIGRATIONS="$PENDING_MIGRATIONS\n- [ ] \`$ID\` - $TITLE"
                ;;
              "in_progress")
                if [ -n "$PR_NUMBER" ]; then
                  IN_PROGRESS_MIGRATIONS="$IN_PROGRESS_MIGRATIONS\n- \`$ID\` - $TITLE ([PR #$PR_NUMBER](https://github.com/${{ github.repository }}/pull/$PR_NUMBER)) - $CURRENT_STEP/$TOTAL_STEPS steps completed"
                else
                  IN_PROGRESS_MIGRATIONS="$IN_PROGRESS_MIGRATIONS\n- \`$ID\` - $TITLE - $CURRENT_STEP/$TOTAL_STEPS steps completed"
                fi
                ;;
              "paused")
                PAUSED_MIGRATIONS="$PAUSED_MIGRATIONS\n- [ ] \`$ID\` - $TITLE (last attempt: step $CURRENT_STEP/$TOTAL_STEPS)"
                ;;
            esac
          done

          # Handle empty sections
          if [ -z "$PENDING_MIGRATIONS" ]; then
            PENDING_MIGRATIONS="\n‚ú® *No pending migrations*"
          fi
          if [ -z "$IN_PROGRESS_MIGRATIONS" ]; then
            IN_PROGRESS_MIGRATIONS="\n‚ú® *No active migrations*"
          fi
          if [ -z "$PAUSED_MIGRATIONS" ]; then
            PAUSED_MIGRATIONS="\n‚ú® *No paused migrations*"
          fi

          # Build complete issue body
          ISSUE_BODY="# üéõÔ∏è Hachiko Migration Control Plane

          This issue tracks all active migrations in the repository. Use the checkboxes below to control migration execution.

          ## üü° Pending Migrations
          $PENDING_MIGRATIONS

          ## üîÑ In-Progress Migrations  
          $IN_PROGRESS_MIGRATIONS

          ## ‚è∏Ô∏è Paused Migrations
          $PAUSED_MIGRATIONS

          ---

          **How to use:**
          - ‚úÖ Check a box next to a pending migration to start it
          - ‚úÖ Check a box next to a paused migration to resume it
          - ‚ùå Closing a Hachiko PR will pause the migration
          - üîÑ This dashboard updates automatically as migrations progress

          ü§ñ *Managed by Hachiko - Do not edit the sections above manually*"

          # Update the issue
          echo "$ISSUE_BODY" | gh issue edit "$ISSUE_NUMBER" --body-file -

          echo "Control-plane issue updated successfully"
