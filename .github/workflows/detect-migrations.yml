name: Detect Migration Documents

# Trigger when migration documents are added or modified
on:
  push:
    branches: [main]
    paths: ["migrations/*.md"]

  # Allow manual trigger for testing
  workflow_dispatch:

permissions:
  contents: write # To create PRs and update files
  issues: write # To update control-plane issue
  pull-requests: write # To create and manage PRs

jobs:
  detect-migrations:
    name: Process Migration Documents
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for comparison

      - name: Install pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.3
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: |
          pnpm install
          pnpm build

      - name: Detect changed migrations
        id: changes
        run: |
          # Get list of changed migration files
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - check all migrations
            CHANGED_FILES=$(find migrations -name "*.md" -type f 2>/dev/null || echo "")
          else
            # Get changed files in migrations/ directory
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep "^migrations/.*\.md$" || echo "")
          fi

          echo "Changed migration files:"
          echo "$CHANGED_FILES"

          # Convert to JSON array for matrix strategy
          MIGRATIONS_JSON=$(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "migrations=$MIGRATIONS_JSON" >> $GITHUB_OUTPUT

          # Check if we have any migrations to process
          if [ -z "$CHANGED_FILES" ] || [ "$CHANGED_FILES" = "" ]; then
            echo "has_migrations=false" >> $GITHUB_OUTPUT
          else
            echo "has_migrations=true" >> $GITHUB_OUTPUT
          fi

  # Process each migration document
  process-migration:
    name: Process Migration
    runs-on: ubuntu-latest
    needs: detect-migrations
    if: needs.detect-migrations.outputs.has_migrations == 'true'

    strategy:
      matrix:
        migration: ${{ fromJson(needs.detect-migrations.outputs.migrations) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.3
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: |
          pnpm install
          pnpm build

      - name: Validate migration document
        id: validate
        run: |
          MIGRATION_FILE="${{ matrix.migration }}"
          echo "Processing migration: $MIGRATION_FILE"

          # Check if file exists
          if [ ! -f "$MIGRATION_FILE" ]; then
            echo "Migration file not found: $MIGRATION_FILE"
            exit 1
          fi

          # Extract frontmatter and validate
          # This would use our TypeScript validation logic
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const migrationPath = '$MIGRATION_FILE';
            const content = fs.readFileSync(migrationPath, 'utf-8');
            
            // Simple frontmatter extraction
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
            if (!frontmatterMatch) {
              console.log('new_migration=true');
              console.log('needs_enhancement=true'); 
              process.exit(0);
            }
            
            const yaml = require('yaml');
            try {
              const frontmatter = yaml.parse(frontmatterMatch[1]);
              console.log('new_migration=false');
              console.log('migration_id=' + (frontmatter.id || 'unknown'));
              console.log('migration_status=' + (frontmatter.status || 'pending'));
              console.log('needs_enhancement=false');
            } catch (e) {
              console.log('new_migration=true');
              console.log('needs_enhancement=true');
            }
          " >> $GITHUB_OUTPUT

      - name: Enhance new migration document
        if: steps.validate.outputs.needs_enhancement == 'true'
        run: |
          echo "Enhancing migration document: ${{ matrix.migration }}"

          # This would trigger a cloud agent to analyze and enhance the document
          # For now, we'll create a simple enhancement
          MIGRATION_FILE="${{ matrix.migration }}"
          MIGRATION_ID=$(basename "$MIGRATION_FILE" .md)

          # Create enhanced version with frontmatter
          TEMP_FILE=$(mktemp)
          cat > "$TEMP_FILE" << EOF
          ---
          schema_version: 1
          id: $MIGRATION_ID
          title: Enhanced migration from $(basename "$MIGRATION_FILE")
          agent: cursor
          status: pending
          current_step: 1
          total_steps: 1
          created: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          last_updated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          ---

          EOF

          # Append original content (skip existing frontmatter if any)
          if grep -q "^---" "$MIGRATION_FILE"; then
            # Skip existing frontmatter
            sed -n '/^---$/,$p' "$MIGRATION_FILE" | tail -n +2 | sed '1,/^---$/d' >> "$TEMP_FILE"
          else
            # No frontmatter, append whole file
            cat "$MIGRATION_FILE" >> "$TEMP_FILE"
          fi

          mv "$TEMP_FILE" "$MIGRATION_FILE"

          echo "Enhanced migration document with frontmatter"

      - name: Create enhancement PR
        if: steps.validate.outputs.needs_enhancement == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MIGRATION_FILE="${{ matrix.migration }}"
          MIGRATION_ID=$(basename "$MIGRATION_FILE" .md)
          BRANCH_NAME="hachiko/enhance-$MIGRATION_ID"

          # Configure git
          git config user.name "hachiko[bot]"
          git config user.email "hachiko@users.noreply.github.com"

          # Create and switch to enhancement branch
          git checkout -b "$BRANCH_NAME"
          git add "$MIGRATION_FILE"
          git commit -m "Enhance migration document: $MIGRATION_ID

          - Add migration frontmatter with metadata
          - Set initial status to pending
          - Ready for review and activation

          ðŸ¤– Generated by Hachiko Migration Detector"

          # Push branch
          git push origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "ðŸ“‹ Enhanced Migration: $MIGRATION_ID" \
            --body "$(cat <<'EOF'
          ## Migration Enhancement

          This PR adds structured frontmatter to the migration document \`$MIGRATION_FILE\`.

          ### Changes
          - âœ… Added migration metadata (ID, title, agent configuration)
          - âœ… Set initial status to \`pending\`
          - âœ… Ready for review and activation

          ### Next Steps
          1. Review the enhanced migration document
          2. Merge this PR to add the migration to the migration dashboard
          3. Check the migration checkbox in the migration-dashboard issue to start execution

          ðŸ¤– Generated by Hachiko Migration Detector
          EOF
          )"

      - name: Update migration-dashboard issue
        if: steps.validate.outputs.new_migration == 'false' && steps.validate.outputs.migration_status == 'pending'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MIGRATION_ID: ${{ steps.validate.outputs.migration_id }}
        run: |
          echo "Would update migration-dashboard issue to add pending migration: $MIGRATION_ID"
          # This step would find/create the migration-dashboard issue and add the migration
          # Implementation in next workflow
