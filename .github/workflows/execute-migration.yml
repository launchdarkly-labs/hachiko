name: Execute Migration Step

# Triggered by control-plane workflow or manually
on:
  workflow_dispatch:
    inputs:
      migration_id:
        description: 'Migration ID to execute'
        required: true
        type: string
      step_id:
        description: 'Step number to execute'
        required: true
        type: string
      force:
        description: 'Force execution even if already in progress'
        required: false
        type: boolean
        default: false

permissions:
  contents: write  # To create PRs and update files
  issues: write    # To update control-plane issue
  pull-requests: write  # To create and manage PRs

jobs:
  execute-migration-step:
    name: Execute Migration Step
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          npm ci
          npm run build
      
      - name: Load migration document
        id: migration
        env:
          MIGRATION_ID: ${{ github.event.inputs.migration_id }}
        run: |
          MIGRATION_FILE="migrations/${MIGRATION_ID}.md"
          
          # Check if migration file exists
          if [ ! -f "$MIGRATION_FILE" ]; then
            echo "‚ùå Migration file not found: $MIGRATION_FILE"
            exit 1
          fi
          
          # Extract and parse frontmatter
          FRONTMATTER=$(awk '/^---$/{if(f==1) exit; f=1; next} f' "$MIGRATION_FILE")
          
          if [ -z "$FRONTMATTER" ]; then
            echo "‚ùå No frontmatter found in migration file"
            exit 1
          fi
          
          # Parse key fields (simplified YAML parsing)
          TITLE=$(echo "$FRONTMATTER" | grep "^title:" | sed 's/title: *//' | tr -d '"'"'"' | tr -d '"')
          AGENT=$(echo "$FRONTMATTER" | grep "^agent:" | sed 's/agent: *//' | tr -d '"'"'"' | tr -d '"')
          STATUS=$(echo "$FRONTMATTER" | grep "^status:" | sed 's/status: *//' | tr -d '"'"'"' | tr -d '"')
          CURRENT_STEP=$(echo "$FRONTMATTER" | grep "^current_step:" | sed 's/current_step: *//')
          TOTAL_STEPS=$(echo "$FRONTMATTER" | grep "^total_steps:" | sed 's/total_steps: *//')
          
          echo "migration_file=$MIGRATION_FILE" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "agent=$AGENT" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "current_step=$CURRENT_STEP" >> $GITHUB_OUTPUT
          echo "total_steps=$TOTAL_STEPS" >> $GITHUB_OUTPUT
          
          echo "üìã Migration: $TITLE"
          echo "ü§ñ Agent: $AGENT"
          echo "üìä Status: $STATUS"
          echo "üìà Progress: $CURRENT_STEP/$TOTAL_STEPS"
      
      - name: Validate execution conditions
        env:
          MIGRATION_STATUS: ${{ steps.migration.outputs.status }}
          CURRENT_STEP: ${{ steps.migration.outputs.current_step }}
          REQUESTED_STEP: ${{ github.event.inputs.step_id }}
          FORCE: ${{ github.event.inputs.force }}
        run: |
          echo "Validating execution conditions..."
          
          # Check if migration is in a valid state for execution
          if [ "$MIGRATION_STATUS" = "completed" ] && [ "$FORCE" != "true" ]; then
            echo "‚ùå Migration already completed. Use force=true to override."
            exit 1
          fi
          
          if [ "$MIGRATION_STATUS" = "in_progress" ] && [ "$FORCE" != "true" ]; then
            echo "‚ùå Migration already in progress. Use force=true to override."
            exit 1
          fi
          
          # Validate step number
          if [ "$REQUESTED_STEP" != "$CURRENT_STEP" ] && [ "$FORCE" != "true" ]; then
            echo "‚ùå Requested step ($REQUESTED_STEP) doesn't match current step ($CURRENT_STEP)"
            exit 1
          fi
          
          echo "‚úÖ Execution conditions validated"
      
      - name: Create working branch
        id: branch
        env:
          MIGRATION_ID: ${{ github.event.inputs.migration_id }}
          STEP_ID: ${{ github.event.inputs.step_id }}
        run: |
          BRANCH_NAME="hachiko/${MIGRATION_ID}-step-${STEP_ID}"
          
          # Configure git
          git config user.name "hachiko[bot]"
          git config user.email "hachiko@users.noreply.github.com"
          
          # Delete branch if it exists (for force execution)
          git branch -D "$BRANCH_NAME" 2>/dev/null || true
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
          
          # Create new branch
          git checkout -b "$BRANCH_NAME"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "üì¶ Created branch: $BRANCH_NAME"
      
      - name: Update migration status to in_progress
        env:
          MIGRATION_FILE: ${{ steps.migration.outputs.migration_file }}
          STEP_ID: ${{ github.event.inputs.step_id }}
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        run: |
          echo "üìù Updating migration status..."
          
          # Update frontmatter in migration document
          # This is a simplified approach - in production, we'd use proper YAML parsing
          sed -i "s/status: .*/status: in_progress/" "$MIGRATION_FILE"
          sed -i "s/current_step: .*/current_step: $STEP_ID/" "$MIGRATION_FILE"
          sed -i "s/last_updated: .*/last_updated: $(date -u +%Y-%m-%dT%H:%M:%SZ)/" "$MIGRATION_FILE"
          
          # Add branch field if not present
          if ! grep -q "^branch:" "$MIGRATION_FILE"; then
            sed -i "/^last_updated:/a branch: $BRANCH_NAME" "$MIGRATION_FILE"
          else
            sed -i "s/branch: .*/branch: $BRANCH_NAME/" "$MIGRATION_FILE"
          fi
          
          # Commit the status update
          git add "$MIGRATION_FILE"
          git commit -m "Update migration status: ${{ github.event.inputs.migration_id }} step $STEP_ID in progress"
          
          echo "‚úÖ Migration status updated"
      
      - name: Execute migration with cloud agent
        id: execute
        env:
          MIGRATION_ID: ${{ github.event.inputs.migration_id }}
          MIGRATION_FILE: ${{ steps.migration.outputs.migration_file }}
          AGENT: ${{ steps.migration.outputs.agent }}
          STEP_ID: ${{ github.event.inputs.step_id }}
        run: |
          echo "üöÄ Executing migration step with $AGENT agent..."
          
          # Extract migration instructions from document (content after frontmatter)
          MIGRATION_CONTENT=$(awk '/^---$/,/^---$/{if(seen++ > 0) next} /^---$/{f=1; next} f' "$MIGRATION_FILE")
          
          # Create agent execution payload
          AGENT_INPUT=$(cat <<EOF
          {
            "planId": "$MIGRATION_ID",
            "stepId": "$STEP_ID",
            "repoPath": "$(pwd)",
            "files": ["src/**/*", "test/**/*", "package.json", "tsconfig.json"],
            "prompt": "$MIGRATION_CONTENT",
            "timeout": 1200,
            "metadata": {
              "branch": "${{ steps.branch.outputs.branch_name }}",
              "repository": "${{ github.repository }}"
            }
          }
          EOF
          )
          
          # Mock agent execution for now (replace with actual agent API calls)
          echo "Agent Input:"
          echo "$AGENT_INPUT"
          
          # Simulate agent work
          sleep 5
          
          # Create some example changes
          echo "// Migration step $STEP_ID completed by $AGENT agent" >> src/migration-log.txt
          git add -A
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "output=No changes needed for this step" >> $GITHUB_OUTPUT
          else
            git commit -m "Apply migration: $MIGRATION_ID step $STEP_ID

          Automated changes applied by $AGENT cloud agent.
          
          Migration: ${{ steps.migration.outputs.title }}
          Step: $STEP_ID
          
          ü§ñ Generated by Hachiko"
            
            echo "success=true" >> $GITHUB_OUTPUT
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "output=Migration step applied successfully" >> $GITHUB_OUTPUT
          fi
          
          echo "‚úÖ Agent execution completed"
      
      - name: Push changes and create PR
        if: steps.execute.outputs.success == 'true' && steps.execute.outputs.changes_made == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MIGRATION_ID: ${{ github.event.inputs.migration_id }}
          STEP_ID: ${{ github.event.inputs.step_id }}
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
          MIGRATION_TITLE: ${{ steps.migration.outputs.title }}
          TOTAL_STEPS: ${{ steps.migration.outputs.total_steps }}
        run: |
          echo "üì§ Pushing changes and creating PR..."
          
          # Push the branch
          git push origin "$BRANCH_NAME"
          
          # Create pull request
          PR_NUMBER=$(gh pr create \
            --title "üîÑ Migration: $MIGRATION_TITLE (Step $STEP_ID/$TOTAL_STEPS)" \
            --body "$(cat <<EOF
          ## Migration Progress: Step $STEP_ID/$TOTAL_STEPS
          
          **Migration**: \`$MIGRATION_ID\`
          **Title**: $MIGRATION_TITLE
          **Agent**: ${{ steps.migration.outputs.agent }}
          **Branch**: \`$BRANCH_NAME\`
          
          ### Changes Applied
          ${{ steps.execute.outputs.output }}
          
          ### Next Steps
          - Review the changes carefully
          - Merge this PR to advance the migration to step $(($STEP_ID + 1))
          - Close without merging to pause the migration
          
          ü§ñ Generated by Hachiko Migration Executor
          EOF
          )" --json number --jq '.number')
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "üéâ Created PR #$PR_NUMBER"
      
      - name: Update migration with PR number
        if: steps.execute.outputs.success == 'true' && steps.execute.outputs.changes_made == 'true'
        env:
          MIGRATION_FILE: ${{ steps.migration.outputs.migration_file }}
          PR_NUMBER: ${{ env.pr_number }}
        run: |
          # Switch back to main branch to update migration document
          git checkout main
          git pull origin main
          
          # Update frontmatter with PR number
          if ! grep -q "^pr_number:" "$MIGRATION_FILE"; then
            sed -i "/^branch:/a pr_number: $PR_NUMBER" "$MIGRATION_FILE"
          else
            sed -i "s/pr_number: .*/pr_number: $PR_NUMBER/" "$MIGRATION_FILE"
          fi
          
          # Update timestamp
          sed -i "s/last_updated: .*/last_updated: $(date -u +%Y-%m-%dT%H:%M:%SZ)/" "$MIGRATION_FILE"
          
          # Commit the update
          git add "$MIGRATION_FILE"
          git commit -m "Update migration document with PR #$PR_NUMBER"
          git push origin main
          
          echo "üìù Updated migration document with PR reference"
      
      - name: Handle execution failure
        if: steps.execute.outputs.success != 'true'
        env:
          MIGRATION_FILE: ${{ steps.migration.outputs.migration_file }}
        run: |
          echo "‚ùå Migration execution failed"
          
          # Switch back to main branch
          git checkout main
          git pull origin main
          
          # Update migration status to failed
          sed -i "s/status: .*/status: failed/" "$MIGRATION_FILE"
          sed -i "s/last_updated: .*/last_updated: $(date -u +%Y-%m-%dT%H:%M:%SZ)/" "$MIGRATION_FILE"
          
          # Add error message
          if ! grep -q "^error:" "$MIGRATION_FILE"; then
            sed -i "/^last_updated:/a error: Agent execution failed" "$MIGRATION_FILE"
          else
            sed -i "s/error: .*/error: Agent execution failed/" "$MIGRATION_FILE"
          fi
          
          git add "$MIGRATION_FILE"
          git commit -m "Mark migration as failed: ${{ github.event.inputs.migration_id }}"
          git push origin main
          
          # Clean up branch
          git push origin --delete "${{ steps.branch.outputs.branch_name }}" || true
          
          exit 1
      
      - name: Trigger control-plane update
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîÑ Triggering control-plane update..."
          gh workflow run control-plane.yml