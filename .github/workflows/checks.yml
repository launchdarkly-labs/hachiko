name: Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  checks: write
  pull-requests: read

jobs:
  lint-type-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Install pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.3
        with:
          node-version: 22
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Oxlint & Oxfmt (lint + format)
        run: pnpm lint && pnpm format

      - name: Build packages
        run: pnpm build

      - name: TypeScript type check
        run: pnpm typecheck

      - name: Verify build artifacts are up to date
        run: |
          # Rebuild and check if there are any meaningful changes to dist/ (excluding source maps)
          echo "ğŸ—ï¸  Running build to verify artifacts are up to date..."
          pnpm build

          # Check for changes excluding source maps which can vary between environments
          # First get all changed files, then filter out .map files
          CHANGED_FILES=$(git diff --name-only dist/ | grep -v '\.map$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "âœ… Build artifacts are up to date"
          else
            echo ""
            echo "âŒ Build artifacts are out of date!"
            echo ""
            echo "ğŸ” The following files have changes after running 'pnpm build':"
            for file in $CHANGED_FILES; do
              echo "   â€¢ $file"
            done
            echo ""
            echo "ğŸ“ Please run the following commands locally to fix this:"
            echo "   pnpm format  # Fix any formatting issues"
            echo "   pnpm build   # Rebuild the project"
            echo "   git add .    # Stage the changes"
            echo "   git commit -m 'Update build artifacts'"
            echo ""
            echo "ğŸ”§ Here are the specific differences found:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Show diff for each changed file with better formatting
            for file in $CHANGED_FILES; do
              echo ""
              echo "ğŸ“„ Changes in $file:"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              git diff "$file" | sed 's/^-/ğŸ”´ -/; s/^+/ğŸŸ¢ +/; s/^@@/ğŸ“ @@/'
            done
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ’¡ This usually happens when:"
            echo "   â€¢ Code formatting rules changed (run 'pnpm format')"
            echo "   â€¢ TypeScript compiler settings changed"
            echo "   â€¢ Source files were updated but dist/ wasn't rebuilt"
            echo ""
            exit 1
          fi

      - name: Unit & Integration Tests
        run: pnpm test:coverage --reporter=junit

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          fail_ci_if_error: false

      - name: Validate workflow shell scripts
        run: |
          echo "ğŸ” Validating workflow shell scripts..."

          # Test migration parsing logic with existing migration files
          echo "Testing migration file parsing logic..."
          for migration_file in migrations/*.md; do
            if [ -f "$migration_file" ]; then
              MIGRATION_ID=$(basename "$migration_file" .md)
              echo "Testing migration: $MIGRATION_ID"
              
              # Test the exact parsing logic from execute-migration.yml
              FRONTMATTER=$(awk '/^---$/{if(f==1) exit; f=1; next} f' "$migration_file")
              
              if [ -z "$FRONTMATTER" ]; then
                echo "âŒ No frontmatter found in $migration_file"
                exit 1
              fi
              
              # Test parsing with simplified approach - avoid complex quote escaping
              TITLE=$(echo "$FRONTMATTER" | grep "^title:" | cut -d':' -f2- | sed 's/^ *//' | sed 's/["\x27]//g')
              AGENT=$(echo "$FRONTMATTER" | grep "^agent:" | cut -d':' -f2- | sed 's/^ *//' | sed 's/["\x27]//g')
              STATUS=$(echo "$FRONTMATTER" | grep "^status:" | cut -d':' -f2- | sed 's/^ *//' | sed 's/["\x27]//g')
              
              echo "  âœ… Parsed: $TITLE (agent: $AGENT, status: $STATUS)"
            fi
          done

          # Validate shell script syntax in workflow files
          echo "Validating shell script syntax in workflow files..."
          find .github/workflows -name "*.yml" | while read workflow; do
            echo "Checking $workflow for shell syntax issues..."
            
            # Extract shell script blocks and basic validation
            # This catches obvious syntax errors like unmatched quotes
            if grep -q "run: |" "$workflow"; then
              echo "  Found shell scripts in $workflow"
              # Check for problematic quote patterns
              if grep -q "'"'"'"'" "$workflow"; then
                echo "  âš ï¸  Complex quote escaping detected - review for syntax errors"
              fi
            fi
          done

          echo "âœ… Workflow validation completed"

      - name: Docs link check
        run: |
          # Simple link checker - can be enhanced later
          echo "Checking documentation links..."
          find docs -name "*.md" | head -5 || echo "No docs directory yet"
